<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sand World OSU Tournament</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code&family=Orbitron:wght@600&display=swap');
    body {
      font-family: 'Fira Code', monospace;
      background: linear-gradient(180deg, #0f0f0f 0%, #1a1a1a 50%, #0f0f0f 100%);
      min-height: 100vh;
    }
    h1, h2 {
      font-family: 'Orbitron', sans-serif;
    }
    
    /* Unified subtle backgrounds - no conflicting gradients */
    .bg-section-dark {
      background-color: rgba(31, 41, 55, 0.3);
    }
    
    .bg-section-darker {
      background-color: rgba(17, 24, 39, 0.5);
    }
    
    .bg-section-darkest {
      background-color: rgba(15, 15, 15, 0.8);
    }
    
    /* Stream section animations */
    .stream-live-indicator {
      animation: pulse-red 2s infinite;
    }
    
    @keyframes pulse-red {
      0%, 100% { 
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }
      50% { 
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
      }
    }
    
    /* Twitch embed responsive */
    .twitch-embed {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
    }
    
    .twitch-embed iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    /* --- Bracket Styles --- */
    .bracket {
      display: flex;
      justify-content: center;
    }
    .round {
      display: flex;
      flex-direction: column;
      justify-content: center;
      width: 280px;
      margin: 0 20px;
    }
    .match-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      flex-grow: 1;
      position: relative;
    }
    .match {
      background-color: #1f2937; /* gray-800 */
      border-radius: 0.5rem;
      padding: 1rem;
      margin: 1rem 0;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
    }
    .player {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #374151; /* gray-700 */
      padding: 0.5rem;
      border-radius: 0.25rem;
    }
    .player.bye {
      color: #6b7280; /* gray-500 */
      font-style: italic;
    }
    .player-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .player-info img {
      width: 2rem;
      height: 2rem;
      border-radius: 9999px;
    }
    .player-pp {
      font-size: 0.875rem;
      color: #9ca3af; /* gray-400 */
    }
    .match .bye-indicator {
      background-color: #3b82f6; /* blue-600 */
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    /* --- Connector Lines --- */
    .connector {
      display: flex;
      align-items: center;
      width: 40px;
    }
    .connector-line {
      width: 100%;
      height: 2px;
      background-color: #4b5563; /* gray-600 */
    }
    .connector.vertical {
      height: 100%;
      width: 2px;
      background-color: #4b5563; /* gray-600 */
      margin: 0 auto;
    }
    .round-connectors {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .connector-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      flex-grow: 1;
      position: relative;
    }

    /* Make BYE matches slightly transparent */
    .match.bye-match {
      opacity: 0.6;
      border: 1px solid #6b7280;
    }
    
    /* Pre-generated bracket structure styles */
    .match.empty-slot {
      opacity: 0.3;
      background-color: #111827; /* gray-900 */
      border: 1px dashed #4b5563; /* gray-600 */
    }
    
    .match.empty-slot .player {
      background-color: #1f2937; /* gray-800 */
      color: #6b7280; /* gray-500 */
      font-style: italic;
    }
    
    /* Improved connector styles for better visibility */
    .connector-line {
      background: linear-gradient(to right, #4b5563, #6b7280, #4b5563);
    }
    
    .connector.vertical {
      background: linear-gradient(to bottom, #4b5563, #6b7280, #4b5563);
    }
    
    /* Tournament tree structure improvements */
    .bracket-stage {
      min-height: 600px;
      display: flex;
      align-items: center;
    }
    
    .round-title {
      writing-mode: vertical-rl;
      text-orientation: mixed;
      transform: rotate(180deg);
      margin: 0 10px;
      color: #9ca3af;
      font-size: 0.875rem;
      font-weight: 600;
    }
  </style>
</head>
<body class="text-gray-100">
  {# build a quick list of eliminated competitor IDs #}
  {% set eliminated_ids = data.eliminated|default([])|map(attribute='id')|list %}
  {% set total = data.competitors|length %}

  <!-- Navigation -->
  <nav class="bg-black border-b border-gray-800 px-6 py-4 flex justify-between items-center">
    <div class="text-yellow-400 font-bold text-2xl tracking-wider">SAND WORLD</div>
    <ul class="flex space-x-6 text-sm font-mono">
      <li><a href="{{ url_for('public.index') }}" class="text-gray-300 hover:text-yellow-400">Home</a></li>
    </ul>
  </nav>

  <!-- Tournament Info -->
  <section class="py-24 px-6 bg-section-dark">
    <div class="max-w-4xl mx-auto text-center">
      <h1 class="text-4xl md:text-5xl font-bold text-yellow-400">Sand World Esports<br>
         OSU Cup 2025</h1>
      <p class="mt-6 text-lg text-gray-300">
        Straight up clicking these circles evil mode.
        <br />
        <span class="italic text-yellow-300">May the most evil clicker win.</span>
      </p>

      <div class="mt-10 text-left text-gray-200 inline-block">
        <h2 class="text-2xl text-yellow-300">üìù Tournament Info</h2>
        <p class="mt-2">Date: 26.7.2025<br>Format: Double Elimination, Best of Seven<br>Details: Held in Lazer, BYO mappool (10 maps)<br>Prize Pool: Two coop Beers</p>
      </div>

      <div class="mt-8">
        <a href="{{ url_for('public.tournament_details') }}" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition transform hover:scale-105 mr-4">
          üìã View Full Rules & Format
        </a>
      </div>

      <div class="mt-6">
        <a href="{{ url_for('public.osu_login') }}" class="inline-block bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 px-10 rounded-full shadow-lg transition transform hover:scale-105">
          Sign Up with osu!
        </a>
      </div>
    </div>
  </section>

  <!-- Live Stream Section -->
  {% if data.get('stream_live') and data.get('twitch_channel') %}
  <section class="py-12 bg-black border-t border-red-600">
    <div class="max-w-6xl mx-auto text-center">
      <h2 class="text-3xl font-bold text-red-400 mb-8 animate-pulse">üî¥ LIVE STREAM</h2>
      
      <div class="bg-gray-900 p-4 rounded-lg shadow-2xl">
        <!-- Twitch Embed -->
        <div class="twitch-embed">
          <iframe 
            src="https://player.twitch.tv/?channel={{ data.twitch_channel }}&parent={{ request.host.split(':')[0] }}&autoplay=false&muted=false"
            frameborder="0"
            allowfullscreen="true"
            scrolling="no"
            class="rounded">
          </iframe>
        </div>
        
        <div class="mt-4 flex items-center justify-between">
          <div class="text-left">
            <p class="text-sm text-gray-300">
              Watching: 
              <a href="https://twitch.tv/{{ data.twitch_channel }}" target="_blank" 
                 class="text-purple-400 hover:text-purple-300 font-bold">
                twitch.tv/{{ data.twitch_channel }}
              </a>
            </p>
          </div>
          
          <div class="flex gap-4">
            <a href="https://twitch.tv/{{ data.twitch_channel }}" target="_blank" 
               class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded text-sm font-bold">
              üì∫ Open in Twitch
            </a>
            <a href="https://twitch.tv/popout/{{ data.twitch_channel }}/chat" target="_blank" 
               class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm">
              üí¨ Pop-out Chat
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>
  {% endif %}
  {% set seeded_competitors = data.competitors | selectattr('placement', 'defined') | list %}
  {% set total_competitors = data.competitors | length %}
  <!-- Match Queue Section -->
  {% if not (total_competitors > 0 and seeded_competitors | length < total_competitors) %}
  <section class="py-12 bg-section-darker border-t border-yellow-600">
    <div class="max-w-6xl mx-auto px-6">
      <h2 class="text-3xl font-bold text-yellow-400 mb-8 text-center">üìã Upcoming Matches</h2>
      
      <div class="grid md:grid-cols-2 gap-8">
        <!-- Current Match -->
        <div class="bg-gray-800 p-6 rounded-lg border-2 border-green-500">
          <h3 class="text-xl font-bold text-green-400 mb-4 flex items-center">
            üéØ Current Match
            {% if data.get('stream_live') %}
              <span class="ml-2 bg-red-600 text-white text-xs px-2 py-1 rounded animate-pulse">LIVE</span>
            {% endif %}
          </h3>
          
          {% set current_match = None %}
          {% set current_bracket_type = None %}
          
          {# Look for current match with priority: in_progress > next_up #}
          {# initialize namespace for mutable variables #}
          {% set ns = namespace(current_match=None, current_bracket_type=None) %}

          {# Check for in_progress matches first #}
          {% for bracket_type in ['upper', 'lower', 'grand_finals'] %}
            {% if not ns.current_match and bracket_type in data.get('brackets', {}) %}
              {% if bracket_type == 'grand_finals' %}
                {% set match = data.brackets[bracket_type] %}
                {% if match and match.get('status') == 'in_progress' %}
                  {% set p1_name = match.get('player1', {}).get('name', '') %}
                  {% set p2_name = match.get('player2', {}).get('name', '') %}
                  {% if p1_name and p2_name and p1_name != 'BYE' and p2_name != 'BYE' %}
                    {% set ns.current_match = match %}
                    {% set ns.current_bracket_type = bracket_type %}
                  {% endif %}
                {% endif %}
              {% else %}
                {% for round_matches in data.brackets[bracket_type] %}
                  {% for match in round_matches %}
                    {% if not ns.current_match and match and match.get('status') == 'in_progress' %}
                      {% set p1_name = match.get('player1', {}).get('name', '') %}
                      {% set p2_name = match.get('player2', {}).get('name', '') %}
                      {% if p1_name and p2_name and p1_name != 'BYE' and p2_name != 'BYE' %}
                        {% set ns.current_match = match %}
                        {% set ns.current_bracket_type = bracket_type %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          
          {# If no in_progress match found, look for next_up matches #}
          {% for bracket_type in ['upper', 'lower', 'grand_finals'] %}
            {% if not ns.current_match and bracket_type in data.get('brackets', {}) %}
              {% if bracket_type == 'grand_finals' %}
                {% set match = data.brackets[bracket_type] %}
                {% if match and match.get('status') == 'next_up' %}
                  {% set p1_name = match.get('player1', {}).get('name', '') %}
                  {% set p2_name = match.get('player2', {}).get('name', '') %}
                  {% if p1_name and p2_name and p1_name != 'BYE' and p2_name != 'BYE' %}
                    {% set ns.current_match = match %}
                    {% set ns.current_bracket_type = bracket_type %}
                  {% endif %}
                {% endif %}
              {% else %}
                {% for round_matches in data.brackets[bracket_type] %}
                  {% for match in round_matches %}
                    {% if not ns.current_match and match and match.get('status') == 'next_up' %}
                      {% set p1_name = match.get('player1', {}).get('name', '') %}
                      {% set p2_name = match.get('player2', {}).get('name', '') %}
                      {% if p1_name and p2_name and p1_name != 'BYE' and p2_name != 'BYE' %}
                        {% set ns.current_match = match %}
                        {% set ns.current_bracket_type = bracket_type %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          
          {# Display current match if found #}
          {% if ns.current_match %}
            <div class="bg-gray-700 p-4 rounded">
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm text-gray-300">{{ ns.current_bracket_type|title|replace('_', ' ') }}</span>
                <span class="text-sm font-mono bg-gray-600 px-2 py-1 rounded">
                  BO7 - First to 4
                </span>
              </div>
              
              <div class="space-y-2">
                <!-- Player 1 -->
                <div class="flex items-center justify-between p-2 bg-gray-600 rounded">
                  <div class="flex items-center gap-3">
                    {% if ns.current_match.get('player1') %}
                      <img src="{{ ns.current_match.player1.get('avatar_url') or 'https://osu.ppy.sh/images/layout/avatar-guest.png' }}" 
                           class="w-8 h-8 rounded-full">
                      <span class="font-semibold">{{ ns.current_match.player1.get('name', 'Unknown') }}</span>
                    {% else %}
                      <span class="text-gray-400 italic">TBD</span>
                    {% endif %}
                  </div>
                  <span class="text-xl font-bold text-yellow-400">{{ ns.current_match.get('score_p1', 0) }}</span>
                </div>
                
                <!-- VS -->
                <div class="text-center text-gray-400 font-bold">VS</div>
                
                <!-- Player 2 -->
                <div class="flex items-center justify-between p-2 bg-gray-600 rounded">
                  <div class="flex items-center gap-3">
                    {% if ns.current_match.get('player2') %}
                      <img src="{{ ns.current_match.player2.get('avatar_url') or 'https://osu.ppy.sh/images/layout/avatar-guest.png' }}" 
                           class="w-8 h-8 rounded-full">
                      <span class="font-semibold">{{ ns.current_match.player2.get('name', 'Unknown') }}</span>
                    {% else %}
                      <span class="text-gray-400 italic">TBD</span>
                    {% endif %}
                  </div>
                  <span class="text-xl font-bold text-yellow-400">{{ ns.current_match.get('score_p2', 0) }}</span>
                </div>
              </div>
              
              {% if ns.current_match.get('status') == 'in_progress' %}
                <div class="mt-3 text-center">
                  <span class="bg-green-600 text-white text-sm px-3 py-1 rounded-full animate-pulse">
                    üî¥ LIVE NOW
                  </span>
                </div>
              {% elif ns.current_match.get('status') == 'next_up' %}
                <div class="mt-3 text-center">
                  <span class="bg-yellow-600 text-white text-sm px-3 py-1 rounded-full">
                    ‚è≥ Starting Soon
                  </span>
                </div>
              {% endif %}
              
              {% if ns.current_match.get('status') in ['in_progress', 'completed'] %}
                <div class="mt-2 text-center">
                  <a href="{{ url_for('public.match_details', match_id=ns.current_match.id) }}"
                     class="inline-flex items-center text-yellow-400 hover:text-yellow-300 text-xs font-bold">
                    üìä Match Details
                  </a>
                </div>
              {% endif %}
            </div>
          {% else %}
            <div class="bg-gray-700 p-4 rounded text-center text-gray-400">
              <p>üèÅ No current match</p>
              <p class="text-sm mt-1">Tournament may be between rounds</p>
              <!-- Debug info -->
              {% set all_matches = [] %}
              {% for bracket_type in ['upper', 'lower', 'grand_finals'] %}
                {% if bracket_type in data.get('brackets', {}) %}
                  {% if bracket_type == 'grand_finals' %}
                    {% set match = data.brackets[bracket_type] %}
                    {% if match %}
                      {% set _ = all_matches.append((match, bracket_type)) %}
                    {% endif %}
                  {% else %}
                    {% for round_matches in data.brackets[bracket_type] %}
                      {% for match in round_matches %}
                        {% if match %}
                          {% set _ = all_matches.append((match, bracket_type)) %}
                        {% endif %}
                      {% endfor %}
                    {% endfor %}
                  {% endif %}
                {% endif %}
              {% endfor %}
              <details class="mt-2 text-xs">
                <summary class="cursor-pointer">Debug: Show all matches ({{ all_matches|length }} total)</summary>
                <div class="mt-2 text-left max-h-40 overflow-y-auto">
                  {% for match, bracket_type in all_matches %}
                    <div class="border-b border-gray-600 py-1">
                      <strong>{{ bracket_type }}</strong>: 
                      {{ match.get('player1', {}).get('name', 'No P1') }} vs {{ match.get('player2', {}).get('name', 'No P2') }} 
                      (Status: {{ match.get('status', 'None') }})
                      <br><small class="text-gray-500">
                        P1: {{ match.get('player1', {}) | string | truncate(50) }}
                        <br>P2: {{ match.get('player2', {}) | string | truncate(50) }}
                      </small>
                    </div>
                  {% endfor %}
                </div>
              </details>
            </div>
          {% endif %}
        </div>
        
        <!-- Next Matches -->
        <div class="bg-gray-800 p-6 rounded-lg border border-gray-600">
          <h3 class="text-xl font-bold text-blue-400 mb-4">‚è≠Ô∏è Coming Up Next</h3>
          
          {% set next_matches = [] %}
          {% for bracket_type in ['upper', 'lower', 'grand_finals'] %}
            {% if bracket_type in data.get('brackets', {}) %}
              {% if bracket_type == 'grand_finals' %}
                {% set match = data.brackets[bracket_type] %}
                {% if match and match.get('status') in ['next_up', None] and (match.player1 or match.player2) and not (current_match and current_match.id == match.id) %}
                  {% set _ = next_matches.append((match, bracket_type)) %}
                {% endif %}
              {% else %}
                {% for round_matches in data.brackets[bracket_type] %}
                  {% for match in round_matches %}
                    {% if match and match.get('status') in ['next_up', None] and (match.player1 or match.player2) and not (current_match and current_match.id == match.id) %}
                      {% set _ = next_matches.append((match, bracket_type)) %}
                    {% endif %}
                  {% endfor %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          
          {% if next_matches %}
            <div class="space-y-3 max-h-96 overflow-y-auto">
              {% for match, bracket_type in next_matches[:5] %}
                <div class="bg-gray-700 p-3 rounded text-sm">
                  <div class="flex justify-between items-center mb-1">
                    <span class="text-xs text-gray-400">{{ bracket_type|title|replace('_', ' ') }}</span>
                    <span class="text-xs bg-gray-600 px-2 py-1 rounded">BO7</span>
                  </div>
                  
                  <div class="flex items-center justify-between">
                    <div class="flex-1">
                      {% if match.player1 %}
                        <span class="font-medium">{{ match.player1.name }}</span>
                      {% else %}
                        <span class="text-gray-400 italic text-xs">TBD</span>
                      {% endif %}
                    </div>
                    <span class="mx-2 text-gray-500">vs</span>
                    <div class="flex-1 text-right">
                      {% if match.player2 %}
                        <span class="font-medium">{{ match.player2.name }}</span>
                      {% else %}
                        <span class="text-gray-400 italic text-xs">TBD</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
              
              {% if next_matches|length > 5 %}
                <div class="text-center text-gray-400 text-sm">
                  ... and {{ next_matches|length - 5 }} more matches
                </div>
              {% endif %}
            </div>
          {% else %}
            <div class="text-center text-gray-400">
              <p>üèÜ Tournament Complete</p>
              <p class="text-sm mt-1">All matches have been played</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </section>
  {% endif %}

  <!-- Competitor Showcase -->
  <section class="py-24 px-6 bg-section-dark">
    <div class="max-w-6xl mx-auto text-center">
      <h2 class="text-3xl md:text-4xl font-bold text-yellow-400 mb-12">Registered Competitors</h2>
      {# make sure total & eliminated_ids are in scope #}
      {% set total = data.competitors|length %}
      {% set eliminated_ids = data.eliminated|default([])|map(attribute='id')|list %}
      <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
        {% for c in data.competitors %}
          {# if this competitor is eliminated, figure out its index in the eliminated_ids list #}
          {% if c.id in eliminated_ids %}
            {% set idx = eliminated_ids.index(c.id) %}
            {% set place = total - idx %}
          {% else %}
            {% set place = none %}
          {% endif %}

          <div class="bg-gray-800 p-4 rounded-xl shadow-lg text-center
                      {% if c.id in eliminated_ids %}opacity-50 line-through text-gray-500{% endif %}">
            <a href="{{ url_for('public.user_profile', user_id=c.id) }}">
              <img src="{{ c.avatar_url or 'https://osu.ppy.sh/images/layout/avatar-guest.png' }}"
                   class="w-24 h-24 rounded-full mx-auto border-2 border-yellow-400">
            </a>
            <h3 class="text-xl font-semibold text-yellow-300 mt-4">{{ c.name }}</h3>
            <p class="text-sm text-gray-400 mt-1">Seed: {{ c.get('placement','‚Äî') }}</p>
            <p class="text-sm text-gray-400 mt-1">PP: {{ "%.0f"|format(c.pp or 0) }}</p>

            {% if place is not none %}
              <p class="text-sm text-yellow-300 mt-2">Place: {{ place }}</p>
            {% endif %}
          </div>
        {% else %}
          <p class="text-gray-400 col-span-full">No competitors have signed up yet.</p>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- Double Elimination Bracket -->
  <section class="py-24 px-6 bg-section-darkest">
    <div class="max-w-full mx-auto px-4">
      <h2 class="text-3xl md:text-4xl font-bold text-yellow-400 mb-12 text-center">Double Elimination Bracket</h2>
      
      {% set seeded_competitors = data.competitors | selectattr('placement', 'defined') | list %}
      {% set total_competitors = data.competitors | length %}
      
      <!-- Seeding Status Disclaimer -->
      {% if total_competitors > 0 and seeded_competitors | length < total_competitors %}
      <div class="mb-8 mx-auto max-w-4xl">
        <div class="bg-yellow-900 border border-yellow-600 rounded-lg p-4 text-center">
          <div class="flex items-center justify-center mb-2">
            <svg class="w-6 h-6 text-yellow-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.962-.833-2.732 0L3.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <h3 class="text-lg font-bold text-yellow-400">Seeding Pending</h3>
          </div>
          <p class="text-yellow-200 text-sm">
            Seeding will be decided based on competitor performance in the seeding matches. Current initial placements are based on Performance Points (PP), and will not be final until the seeding matches are completed.
          </p>
        </div>
      </div>
      {% endif %}
      
      {# Macro to calculate theoretical bracket structure #}
      {% macro calculate_bracket_structure(num_competitors) %}
        {% if num_competitors <= 1 %}{% set next_pow2 = 1 %}
        {% elif num_competitors <= 2 %}{% set next_pow2 = 2 %}
        {% elif num_competitors <= 4 %}{% set next_pow2 = 4 %}
        {% elif num_competitors <= 8 %}{% set next_pow2 = 8 %}
        {% elif num_competitors <= 16 %}{% set next_pow2 = 16 %}
        {% elif num_competitors <= 32 %}{% set next_pow2 = 32 %}
        {% elif num_competitors <= 64 %}{% set next_pow2 = 64 %}
        {% else %}{% set next_pow2 = 128 %}
        {% endif %}
        {{ next_pow2 }}
      {% endmacro %}
      
      {# Macro to generate empty bracket slots for visualization #}
      {% macro generate_empty_match(round_index, match_index, bracket_type='upper') %}
        <div class="match empty-slot">
          <div class="text-center mb-2">
            <span class="inline-block bg-gray-600 text-gray-400 px-2 py-1 rounded-full text-xs">
              üèÅ Awaiting Players
            </span>
          </div>
          <div class="player">
            <div class="player-info">
              <span class="text-gray-500 italic">TBD</span>
            </div>
          </div>
          <div class="player">
            <div class="player-info">
              <span class="text-gray-500 italic">TBD</span>
            </div>
          </div>
        </div>
      {% endmacro %}

      {% macro display_player(player, winner, match) %}
        {% set is_winner = winner and player.id and winner.id == player.id %}
        {% set is_eliminated = player.id and (player.id in eliminated_ids) %}
        {% set is_bye_match = match and (match.player1.name == 'BYE' or match.player2.name == 'BYE') %}
        <div class="player 
             {% if player.name == 'BYE' %}bye{% endif %} 
             {% if is_winner %}border-2 border-yellow-400 bg-gray-600{% endif %}
             {% if is_eliminated %}opacity-50 line-through text-gray-500{% endif %}">
          <div class="player-info">
            <span class="text-xs text-black-500 mr-2">#{{ player.get('placement','‚Äî') }}</span>
            {% if player.name != 'BYE' and player.id %}
            <a href="{{ url_for('public.user_profile', user_id=player.id) }}">
              <img src="{{ player.avatar_url or 'https://osu.ppy.sh/images/layout/avatar-guest.png' }}"
                   alt="{{ player.name }}'s avatar">
            </a>
            <a href="{{ url_for('public.user_profile', user_id=player.id) }}"
               class="{% if is_winner %}text-yellow-300 font-bold{% endif %}">
              {{ player.name }}
            </a>
            {% else %}
            <span class="{% if is_winner %}text-yellow-300 font-bold{% endif %} text-gray-500 italic">{{ player.name }}</span>
            {% endif %}
          </div>
          <div class="flex items-center gap-2">
            <!-- Show score only for real matches (not BYE matches) -->
            {% if match and not is_bye_match and (match.get('score_p1', 0) > 0 or match.get('score_p2', 0) > 0 or match.get('winner')) %}
            <div class="text-sm font-mono">
              {% if player.id == match.player1.id %}
                <span class="{% if is_winner %}text-yellow-300 font-bold{% endif %}">{{ match.get('score_p1', 0) }}</span>
              {% elif player.id == match.player2.id %}
                <span class="{% if is_winner %}text-yellow-300 font-bold{% endif %}">{{ match.get('score_p2', 0) }}</span>
              {% endif %}
            </div>
            {% endif %}
            <!-- Placement for eliminated players -->
            {% set pplace = none %}
            {% for e in data.eliminated|default([]) %}
              {% if e.id == player.id %}
                {% set pplace = total - loop.index0 %}
              {% endif %}
            {% endfor %}
            {% if pplace %}
              <div class="text-xs text-yellow-300">P{{ pplace }}</div>
            {% endif %}
          </div>
        </div>
      {% endmacro %}

      <!-- Grand Finals -->
      {% if data.brackets.grand_finals %}
      <div class="mb-16">
        <h2 class="text-3xl md:text-5xl font-bold text-yellow-400 mb-12 text-center">Grand Finals</h2>
        
        <!-- Show previous grand finals match if bracket was reset -->
        {% if data.brackets.grand_finals.get('is_bracket_reset') and data.brackets.grand_finals.get('previous_gf') %}
        <div class="mb-8">
          <h3 class="text-xl text-gray-400 mb-4 text-center">Grand Finals - Match 1 (Bracket Reset)</h3>
          <div class="bracket">
            <div class="round">
              <div class="match-container">
                <div class="match border-2 border-gray-500 shadow-xl opacity-75">
                  {% set prev_match = data.brackets.grand_finals.previous_gf %}
                  {{ display_player(prev_match.player1, prev_match.winner, prev_match) }}
                  {{ display_player(prev_match.player2, prev_match.winner, prev_match) }}
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- Current/final grand finals match -->
        <div>
          {% if data.brackets.grand_finals.get('is_bracket_reset') %}
          <h3 class="text-xl text-yellow-300 mb-4 text-center">Grand Finals - Match 2 (Championship)</h3>
          {% endif %}
          <div class="bracket">
            <div class="round">
              <div class="match-container">
                <div class="match border-4 border-yellow-400 shadow-2xl">
                  {% set match = data.brackets.grand_finals %}
                  {{ display_player(match.player1, match.winner, match) }}
                  {{ display_player(match.player2, match.winner, match) }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      {# Calculate expected tournament structure #}
      {% set total_competitors = data.competitors | length %}
      {% if total_competitors <= 1 %}{% set power_of_two = 1 %}
      {% elif total_competitors <= 2 %}{% set power_of_two = 2 %}
      {% elif total_competitors <= 4 %}{% set power_of_two = 4 %}
      {% elif total_competitors <= 8 %}{% set power_of_two = 8 %}
      {% elif total_competitors <= 16 %}{% set power_of_two = 16 %}
      {% elif total_competitors <= 32 %}{% set power_of_two = 32 %}
      {% elif total_competitors <= 64 %}{% set power_of_two = 64 %}
      {% else %}{% set power_of_two = 128 %}
      {% endif %}
      
      {# Calculate expected rounds #}
      {% if power_of_two <= 1 %}{% set expected_rounds = 0 %}
      {% elif power_of_two <= 2 %}{% set expected_rounds = 1 %}
      {% elif power_of_two <= 4 %}{% set expected_rounds = 2 %}
      {% elif power_of_two <= 8 %}{% set expected_rounds = 3 %}
      {% elif power_of_two <= 16 %}{% set expected_rounds = 4 %}
      {% elif power_of_two <= 32 %}{% set expected_rounds = 5 %}
      {% elif power_of_two <= 64 %}{% set expected_rounds = 6 %}
      {% else %}{% set expected_rounds = 7 %}
      {% endif %}
      
      <div class="bracket-stage">
        <!-- Upper Bracket -->
        <div class="flex">
          {# Show existing rounds #}
          {% for round_matches in data.brackets.upper %}
          <div class="round">
            <h3 class="text-xl font-semibold text-pink-500 mb-6 text-center">Round {{ loop.index }}</h3>
            {% for match in round_matches %}
            <div class="match-container">
              <div class="match 
                   {% if match.get('status') == 'in_progress' %}border-2 border-green-400 shadow-green-400/50{% endif %}
                   {% if match.get('status') == 'completed' %}opacity-75{% endif %}
                   {% if match.player1.name == 'BYE' or match.player2.name == 'BYE' %}opacity-60 border border-gray-600{% endif %}">
                
                <!-- Status indicator for public view -->
                {% if match.player1.name == 'BYE' or match.player2.name == 'BYE' %}
                <div class="text-center mb-2">
                  <span class="inline-block bg-blue-600 text-white px-2 py-1 rounded-full text-xs">
                    ‚ÜóÔ∏è BYE - Auto Advance
                  </span>
                </div>
                {% elif match.get('status') == 'in_progress' %}
                <div class="text-center mb-2">
                  <span class="inline-block bg-red-500 text-white px-2 py-1 rounded-full text-xs animate-pulse">
                    üî¥ LIVE NOW
                  </span>
                </div>
                {% elif match.get('status') == 'next_up' %}
                <div class="text-center mb-2">
                  <span class="inline-block bg-gray-600 text-white px-2 py-1 rounded-full text-xs">
                    ‚è≥ Coming Up
                  </span>
                </div>
                {% endif %}
                
                {{ display_player(match.player1, match.winner, match) }}
                {{ display_player(match.player2, match.winner, match) }}
                
                <!-- Show multiplayer room link only for real matches -->
                {% if not (match.player1.name == 'BYE' or match.player2.name == 'BYE') %}
                  {% if match.get('mp_room_url') and match.get('status') == 'in_progress' %}
                  <div class="mt-2 text-center">
                    <a href="{{ match.mp_room_url }}" target="_blank" 
                       class="inline-flex items-center text-red-400 hover:text-red-300 text-sm font-bold animate-pulse">
                      üî¥ WATCH LIVE
                      <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                      </svg>
                    </a>
                  </div>
                  {% endif %}
                  
                  <!-- Add clickable match details link -->
                  {% if match.get('status') in ['in_progress', 'completed'] %}
                  <div class="mt-2 text-center">
                    <a href="{{ url_for('public.match_details', match_id=match.id) }}" 
                       class="inline-flex items-center text-yellow-400 hover:text-yellow-300 text-xs font-bold">
                      üìä Match Details
                    </a>
                  </div>
                  {% endif %}
                  
                  <!-- Show match score if completed and not a BYE -->
                  {% if match.get('winner') and (match.get('score_p1', 0) > 0 or match.get('score_p2', 0) > 0) %}
                  <div class="mt-2 text-center">
                    <span class="text-xs text-gray-400 font-mono">
                      Final: {{ match.get('score_p1', 0) }} - {{ match.get('score_p2', 0) }}
                    </span>
                  </div>
                  {% endif %}
                {% else %}
                <!-- BYE match explanation -->
                <div class="mt-2 text-center">
                  <span class="text-xs text-gray-400 italic">
                    {% if match.player1.name == 'BYE' %}
                      {{ match.player2.name }} advances automatically
                    {% else %}
                      {{ match.player1.name }} advances automatically
                    {% endif %}
                  </span>
                </div>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
          {% if not loop.last %}
          <div class="round-connectors">
            {% for match in round_matches | batch(2) %}
            <div class="connector-container">
              <div class="connector"><div class="connector-line"></div></div>
              <div class="connector vertical"></div>
              <div class="connector"><div class="connector-line"></div></div>
            </div>
            {% endfor %}
          </div>
          {% endif %}
          {% endfor %}
          
          {# Show future rounds as placeholders if tournament is still active #}
          {% if data.brackets.upper and total_competitors > 1 %}
            {% set current_rounds = data.brackets.upper | length %}
            
            {% for future_round in range(current_rounds + 1, expected_rounds + 1) %}
              {% if future_round <= expected_rounds %}
              <div class="round-connectors">
                <div class="connector-container">
                  <div class="connector"><div class="connector-line"></div></div>
                  <div class="connector vertical"></div>
                  <div class="connector"><div class="connector-line"></div></div>
                </div>
              </div>
              <div class="round">
                <h3 class="text-xl font-semibold text-pink-300 mb-6 text-center opacity-50">Round {{ future_round }}</h3>
                {# Calculate matches in this round #}
                {% if future_round == 1 %}{% set matches_in_round = power_of_two // 2 %}
                {% elif future_round == 2 %}{% set matches_in_round = power_of_two // 4 %}
                {% elif future_round == 3 %}{% set matches_in_round = power_of_two // 8 %}
                {% elif future_round == 4 %}{% set matches_in_round = power_of_two // 16 %}
                {% elif future_round == 5 %}{% set matches_in_round = power_of_two // 32 %}
                {% elif future_round == 6 %}{% set matches_in_round = power_of_two // 64 %}
                {% else %}{% set matches_in_round = 1 %}
                {% endif %}
                {% for match_num in range(matches_in_round) %}
                <div class="match-container">
                  {{ generate_empty_match(future_round - 1, match_num, 'upper') }}
                </div>
                {% endfor %}
              </div>
              {% endif %}
            {% endfor %}
          {% endif %}
        </div>
      </div>

      <!-- Lower Bracket -->
      <div class="mt-16">
        <h3 class="text-3xl md:text-4xl font-bold text-blue-400 mb-12 text-center">Lower Bracket</h3>
        
        {# Calculate expected lower bracket structure based on actual double elimination format #}
        {% if power_of_two <= 2 %}
          {% set expected_lower_rounds = 1 %}
          {% set total_lower_matches = 1 %}
        {% elif power_of_two <= 4 %}
          {% set expected_lower_rounds = 2 %}
          {% set total_lower_matches = 2 %}
        {% elif power_of_two <= 8 %}
          {% set expected_lower_rounds = 4 %}
          {% set total_lower_matches = 4 %}
        {% elif power_of_two <= 16 %}
          {% set expected_lower_rounds = 6 %}
          {% set total_lower_matches = 8 %}
        {% elif power_of_two <= 32 %}
          {% set expected_lower_rounds = 8 %}
          {% set total_lower_matches = 16 %}
        {% else %}
          {% set expected_lower_rounds = 10 %}
          {% set total_lower_matches = 32 %}
        {% endif %}
        
        {# Count actual lower bracket matches #}
        {% set actual_lower_matches = 0 %}
        {% if data.brackets.lower %}
          {% for round_matches in data.brackets.lower %}
            {% set actual_lower_matches = actual_lower_matches + round_matches|length %}
          {% endfor %}
        {% endif %}
        
        {# Determine if lower bracket is fully populated #}
        {% set is_lower_bracket_complete = actual_lower_matches >= total_lower_matches %}
        
        <!-- Hybrid lower bracket view: show populated matches + placeholders -->
        <div class="bracket-stage">
          <div class="flex">
            {# Show existing populated rounds #}
            {% if data.brackets.lower %}
              {% for round_matches in data.brackets.lower %}
              <div class="round">
                <h3 class="text-xl font-semibold text-blue-500 mb-6 text-center">Round {{ loop.index }}</h3>
                {% for match in round_matches %}
                <div class="match-container">
                  <div class="match 
                       {% if match.get('status') == 'in_progress' %}border-2 border-green-400 shadow-green-400/50{% endif %}
                       {% if match.get('status') == 'completed' %}opacity-75{% endif %}">
                    
                    <!-- Status indicator for public view -->
                    {% if match.get('status') == 'in_progress' %}
                    <div class="text-center mb-2">
                      <span class="inline-block bg-red-500 text-white px-2 py-1 rounded-full text-xs animate-pulse">
                        üî¥ LIVE NOW
                      </span>
                    </div>
                    {% elif match.get('status') == 'next_up' %}
                    <div class="text-center mb-2">
                      <span class="inline-block bg-gray-600 text-white px-2 py-1 rounded-full text-xs">
                        ‚è≥ Coming Up
                      </span>
                    </div>
                    {% endif %}
                    
                    {{ display_player(match.player1, match.winner, match) }}
                    {{ display_player(match.player2, match.winner, match) }}
                    
                    <!-- Show multiplayer room link if available and match is in progress -->
                    {% if match.get('mp_room_url') and match.get('status') == 'in_progress' %}
                    <div class="mt-2 text-center">
                      <a href="{{ match.mp_room_url }}" target="_blank" 
                         class="inline-flex items-center text-red-400 hover:text-red-300 text-sm font-bold animate-pulse">
                        üî¥ WATCH LIVE
                        <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                      </a>
                    </div>
                    
                    {% elif match.get('mp_room_url') and match.get('status') == 'completed' %}
                    <div class="mt-2 text-center">
                      <a href="{{ match.mp_room_url }}" target="_blank" 
                         class="inline-flex items-center text-blue-400 hover:text-blue-300 text-xs">
                        üì∫ View Match
                      </a>
                    </div>
                    {% endif %}
                    
                    <!-- Add clickable match details link -->
                    {% if match.get('status') in ['in_progress', 'completed'] %}
                    <div class="mt-2 text-center">
                      <a href="{{ url_for('public.match_details', match_id=match.id) }}" 
                         class="inline-flex items-center text-yellow-400 hover:text-yellow-300 text-xs font-bold">
                        üìä Match Details
                      </a>
                    </div>
                    {% endif %}
                    
                    <!-- Show match score if completed -->
                    {% if match.get('winner') and (match.get('score_p1', 0) > 0 or match.get('score_p2', 0) > 0) %}
                    <div class="mt-2 text-center">
                      <span class="text-xs text-gray-400 font-mono">
                        Final: {{ match.get('score_p1', 0) }} - {{ match.get('score_p2', 0) }}
                      </span>
                    </div>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
              {% if not loop.last %}
                <div class="round-connectors">
                  {% for match in round_matches | batch(2) %}
                  <div class="connector-container">
                    <div class="connector"><div class="connector-line"></div></div>
                    <div class="connector vertical"></div>
                    <div class="connector"><div class="connector-line"></div></div>
                  </div>
                  {% endfor %}
                </div>
              {% endif %}
              {% endfor %}
              
              {# Show connectors to future rounds if not complete #}
              {% if not is_lower_bracket_complete and expected_lower_rounds > data.brackets.lower|length %}
                <div class="round-connectors">
                  <div class="connector-container">
                    <div class="connector"><div class="connector-line opacity-30"></div></div>
                    <div class="connector vertical opacity-30"></div>
                    <div class="connector"><div class="connector-line opacity-30"></div></div>
                  </div>
                </div>
              {% endif %}
            {% endif %}
            
            {# Show placeholder rounds for remaining lower bracket structure #}
            {% if not is_lower_bracket_complete %}
              {% set current_lower_rounds = data.brackets.lower|length if data.brackets.lower else 0 %}
              
              {# Show preview structure for missing rounds based on actual double elimination structure #}
              {% for future_round in range(current_lower_rounds + 1, expected_lower_rounds + 1) %}
                {% if future_round <= expected_lower_rounds %}
                <div class="round opacity-30">
                  <h3 class="text-xl font-semibold text-blue-300 mb-6 text-center">Round {{ future_round }}</h3>
                  
                  {# Calculate matches in this future round based on actual double elimination structure #}
                  {% if power_of_two <= 4 %}
                    {# 4-man bracket: 1-1 lower bracket structure #}
                    {% set future_matches = 1 %}
                  {% elif power_of_two <= 8 %}
                    {# 8-man bracket: 1-2-1-1 lower bracket structure (for 7-man tournament) #}
                    {% if future_round == 1 %}
                      {% set future_matches = 1 %}
                    {% elif future_round == 2 %}
                      {% set future_matches = 2 %}
                    {% elif future_round == 3 %}
                      {% set future_matches = 1 %}
                    {% else %}
                      {% set future_matches = 1 %}
                    {% endif %}
                  {% elif power_of_two <= 16 %}
                    {# 16-man bracket: 2-4-2-2-1-1 lower bracket structure #}
                    {% if future_round == 1 %}
                      {% set future_matches = 2 %}
                    {% elif future_round == 2 %}
                      {% set future_matches = 4 %}
                    {% elif future_round == 3 %}
                      {% set future_matches = 2 %}
                    {% elif future_round == 4 %}
                      {% set future_matches = 2 %}
                    {% elif future_round == 5 %}
                      {% set future_matches = 1 %}
                    {% else %}
                      {% set future_matches = 1 %}
                    {% endif %}
                  {% else %}
                    {# Default calculation for larger brackets #}
                    {% if future_round == expected_lower_rounds %}
                      {% set future_matches = 1 %}
                    {% elif future_round % 2 == 1 %}
                      {% set future_matches = (power_of_two // (4 * (2 ** ((future_round - 1) // 2)))) %}
                    {% else %}
                      {% set future_matches = (power_of_two // (2 * (2 ** (future_round // 2)))) %}
                    {% endif %}
                  {% endif %}
                  
                  {% for match_num in range(future_matches) %}
                  <div class="match-container">
                    <div class="match empty-slot">
                      <div class="text-center mb-2">
                        <span class="inline-block bg-blue-600 text-blue-200 px-2 py-1 rounded-full text-xs">
                          {% if future_round == expected_lower_rounds %}
                            üèÜ Lower Finals
                          {% else %}
                            üïê Awaiting Players
                          {% endif %}
                        </span>
                      </div>
                      <div class="player">
                        <div class="player-info">
                          <span class="text-blue-400 italic">TBD</span>
                        </div>
                      </div>
                      <div class="player">
                        <div class="player-info">
                          <span class="text-blue-400 italic">TBD</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                
                {# Show connectors between future rounds #}
                {% if not loop.last %}
                <div class="round-connectors opacity-30">
                  <div class="connector-container">
                    <div class="connector"><div class="connector-line"></div></div>
                    <div class="connector vertical"></div>
                    <div class="connector"><div class="connector-line"></div></div>
                  </div>
                </div>
                {% endif %}
                {% endif %}
              {% endfor %}
            {% endif %}
          </div>
        </div>
      </div>

    </div>
  </section>

  <footer class="py-8 text-center text-sm text-gray-500 bg-black border-t border-gray-800">
    &copy; 2025 Sand World Evil Financing. Paid for by Lebanese Taxpayers.
  </footer>

</body>
</html>